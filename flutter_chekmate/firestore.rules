rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions to check authentication and ownership
    function isAuth() { 
      return request.auth != null; 
    }
    function isOwner(uid) { 
      return request.auth.uid == uid; 
    }
    
    // By default, deny all reads and writes to prevent accidental open collections
    match /{document=**} { 
      allow read, write: if false; 
    }
    
    // Users can read any profile, but only write to their own
    match /users/{userId} {
      allow read: if isAuth();
      allow write: if isAuth() && isOwner(userId);
    }
    
    // Users can read any post, create their own, and only modify/delete their own
    match /posts/{postId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isAuth() && resource.data.authorId == request.auth.uid;
    }
    
    // Users can read messages they are a part of and create new messages
    match /messages/{messageId} {
      allow read: if isAuth() && request.auth.uid in resource.data.participants;
      allow create: if isAuth();
    }
  }
}